rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* =========================
       FUNÇÕES AUXILIARES
    ========================== */

    function estaLogado() {
      return request.auth != null;
    }

    // Le o doc do usuário atual para verificar permissões
    // ATENÇÃO: Isso custa 1 leitura adicional por requisição
    function getUsuarioAtual() {
      return get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data;
    }

    function usuarioExiste() {
      return exists(/databases/$(database)/documents/usuarios/$(request.auth.uid));
    }

    function ehAdmin() {
      return estaLogado() && 
             usuarioExiste() && 
             getUsuarioAtual().papel == 'administrador' && 
             getUsuarioAtual().ativo == true;
    }

    function ehUsuarioAtivo() {
      return estaLogado() && 
             usuarioExiste() && 
             getUsuarioAtual().ativo == true;
    }

    /* =========================
       USUÁRIOS (DOC PRINCIPAL)
       /usuarios/{uid}
    ========================== */
    match /usuarios/{uid} {
      // 1) Admin pode ler/escrever qualquer usuário
      // 2) O próprio usuário pode ler seu doc (mesmo se inativo, para saber que está bloqueado)
      // 3) Ninguém mais pode ler
      allow read: if (estaLogado() && request.auth.uid == uid) || ehAdmin();

      // Escrita apenas Admin (o usuário não edita seu próprio papel/status)
      allow write: if ehAdmin();

      /* =========================
         SUBCOLEÇÕES (oficinas, configuracoes, alunos, etc)
      ========================== */
      match /{document=**} {
        // Admin lê e escreve tudo
        allow read, write: if ehAdmin();

        // Usuário (Se ativo) lê e escreve nas SUAS subcoleções
        allow read, write: if ehUsuarioAtivo() && request.auth.uid == uid;
      }
    }

    /* =========================
       BLOQUEIO DE COLEÇÕES GLOBAIS ANTIGAS
    ========================== */
    match /alunos/{document=**} { allow read, write: if false; }
    match /oficinas/{document=**} { allow read, write: if false; }
    match /configuracoes/{document=**} { allow read, write: if false; }
  }
}

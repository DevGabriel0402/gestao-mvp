rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* =========================
       FUNÇÕES AUXILIARES
    ========================== */
    function estaLogado() {
      return request.auth != null;
    }

    // Helper para ler dados do usuário do DB (se claims falharem ou para compatibilidade)
    function dadosUsuario() {
      return get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data;
    }

    function usuarioAtivo() {
      return estaLogado() && dadosUsuario().ativo == true;
    }

    // Verifica se é admin (via Claim OU via DB)
    // Verifica se é admin (via Claim OU via DB)
    function ehAdmin() {
      return usuarioAtivo() && (
        (request.auth.token.keys().hasAll(['papel']) && request.auth.token.papel == "administrador") || 
        dadosUsuario().papel == "administrador"
      );
    }

    /* =========================
       USUÁRIOS (DOC PRINCIPAL)
    ========================== */
    match /usuarios/{uid} {
      // Admin lê lista de usuários (para gestão)
      // Usuário lê apenas o próprio perfil
      allow read: if ehAdmin() || (estaLogado() && uid == request.auth.uid);

      // Apenas admin cria/atualiza/deleta usuários (via Client SDK se permitido, mas idealmente é via Admin SDK)
      // Como estamos usando Admin SDK nas Cloud Functions, essas regras de write aqui são para segurança extra
      // caso tentemos escrever direto do front (ex: editar perfil próprio).
      allow create, update, delete: if ehAdmin();

      /* =========================
         SUBCOLEÇÕES DO USUÁRIO
         - oficinas
         - configuracoes
         - alunos
      ========================== */
      match /{subcolecao}/{docId} {
        // Leitura: Admin pode ler tudo (para relatórios/gestão)
        // Usuário lê o seu
        allow read: if ehAdmin() || (estaLogado() && uid == request.auth.uid);

        // Escrita:
        // - Admin pode tudo (se precisar corrigir algo)
        // - Usuário pode escrever nas suas subcoleções (alunos, etc)
        allow create, update: if ehAdmin() || (
           estaLogado() && uid == request.auth.uid && 
           (subcolecao == "alunos" || subcolecao == "oficinas" || subcolecao == "configuracoes")
        );

        // Delete: Admin ou o próprio usuário (ex: deletar aluno)
        allow delete: if ehAdmin() || (estaLogado() && uid == request.auth.uid && subcolecao == "alunos");
      }
    }
  }
}
